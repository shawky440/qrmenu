<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…Ù†ÙŠÙˆ Ø§Ù„Ù…Ø·Ø¹Ù…</title>

<style>
body { margin:0; font-family:Tahoma; background:#f5f5f5; }
header {
    background:#d62828;
    color:#fff;
    text-align:center;
    padding:18px;
    font-size:26px;
    cursor:pointer;
}

.categories-bar {
    display:flex;
    gap:12px;
    padding:10px;
    background:#fff;
    overflow-x:auto;
}

.category {
    background:#d62828;
    color:#fff;
    padding:10px 18px;
    border-radius:10px;
    cursor:pointer;
}

.items {
    display:flex;
    flex-wrap:wrap;
    justify-content:center;
    gap:16px;
    margin:15px;
}

.item {
    width:150px;
    background:#fff;
    border-radius:12px;
    box-shadow:0 4px 10px rgba(0,0,0,.1);
    cursor:pointer;
}

.item img {
    width:100%;
    height:130px;
    object-fit:cover;
}

.item .info {
    padding:10px;
    text-align:center;
    font-weight:bold;
}

/* Popup */
.details-popup {
    display:none;
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.6);
    justify-content:center;
    align-items:center;
}

.details-content {
    background:#fff;
    padding:20px;
    width:90%;
    max-width:400px;
    border-radius:12px;
}

.unit-item {
    background:#fff;
    border-radius:10px;
    padding:10px;
    margin:8px 0;
    box-shadow:0 3px 8px rgba(0,0,0,.15);
    cursor:pointer;
    text-align:center;
}

.unit-item:hover { background:#f9f9f9; }

/* Cart */
#cartBox {
    position:fixed;
    bottom:60px;
    right:10px;
    width:280px;
    background:#fff;
    border-radius:12px;
    box-shadow:0 4px 12px rgba(0,0,0,.25);
    padding:12px;
    z-index:999;
}

#cartBox h4 { margin:5px 0; }

.cart-row {
    border-bottom:1px solid #eee;
    padding:6px 0;
}

.cart-row button {
    margin:0 4px;
}

footer {
    position:fixed;
    bottom:0;
    width:100%;
    background:#222;
    color:#fff;
    text-align:center;
    padding:10px;
}
</style>
</head>

<body>

<header onclick="syncFromApi()">Ù…Ø·Ø¹Ù… ÙˆØ§Ø­Ø© Ø¯Ù…Ø´Ù‚</header>

<div id="menu" class="categories-bar"></div>
<div id="itemsContainer" class="items"></div>

<!-- Popup -->
<div id="detailsPopup" class="details-popup">
    <div class="details-content">
        <div id="detailsContent"></div>
        <button onclick="closePopup()" style="
        width:100%;margin-top:15px;
        background:#d62828;color:#fff;
        padding:12px;border:none;
        border-radius:10px;font-size:18px">
        Ù…ÙˆØ§ÙÙ‚
        </button>
    </div>
</div>

<!-- Cart -->
<div id="cartBox">
<h4>ğŸ›’ Ø§Ù„Ø·Ù„Ø¨</h4>
<div id="cartItems"></div>
<strong id="cartTotal"></strong>

<button onclick="sendOrder()" style="
width:100%;margin-top:8px;
background:#25D366;color:#fff;
padding:10px;border:none;
border-radius:8px">
Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ§ØªØ³Ø§Ø¨
</button>

<button onclick="clearCart()" style="
width:100%;margin-top:6px;
background:#d62828;color:#fff;
padding:8px;border:none;
border-radius:8px">
Ù…Ø³Ø­ Ø§Ù„Ø·Ù„Ø¨
</button>
</div>

<footer>Â© 2025 MicrosysEgypt</footer>

<script>
/* ================= DATA STORAGE ================= */
let cart = JSON.parse(localStorage.getItem("cart")) || [];
let data = JSON.parse(localStorage.getItem("menuData"));

/* ================= API URLS ================= */
const API = {
    categories: "http://192.168.1.2:5000/api/Categories?formid=7",
    items: id => `http://192.168.1.2:5000/api/Items/ByCategory/${id}`,
    units: id => `http://192.168.1.2:5000/api/Items/${id}/Units`
};

/* ================= LOAD MENU ================= */
async function loadCategories() {
    if (!navigator.onLine && data) {
        renderCategories(data.categories);
        return;
    }

    const res = await fetch(API.categories);
    const categories = await res.json();
    data = { categories, items:{}, units:{} };
    localStorage.setItem("menuData", JSON.stringify(data));
    renderCategories(categories);
}

function renderCategories(categories) {
    menu.innerHTML="";
    categories.forEach(c=>{
        const d=document.createElement("div");
        d.className="category";
        d.textContent=c.nameA;
        d.onclick=()=>loadItems(c.id);
        menu.appendChild(d);
    });
}

async function loadItems(catId) {
    if (data.items[catId]) {
        renderItems(data.items[catId]);
        return;
    }
    const res=await fetch(API.items(catId));
    const items=await res.json();
    data.items[catId]=items;
    localStorage.setItem("menuData",JSON.stringify(data));
    renderItems(items);
}

function renderItems(items) {
    itemsContainer.innerHTML="";
    items.forEach(i=>{
        const d=document.createElement("div");
        d.className="item";
        d.innerHTML=`
        <img src="${i.itemImg?`data:image/jpeg;base64,${i.itemImg}`:'noimage.png'}">
        <div class="info">${i.nameA}</div>`;
        d.onclick=()=>loadUnits(i.id,i.nameA);
        itemsContainer.appendChild(d);
    });
}

async function loadUnits(id,name) {
    detailsPopup.style.display="flex";
    if (data.units[id]) {
        renderUnits(name,data.units[id]);
        return;
    }
    const res=await fetch(API.units(id));
    const units=await res.json();
    data.units[id]=units;
    localStorage.setItem("menuData",JSON.stringify(data));
    renderUnits(name,units);
}

function renderUnits(name,units){
    detailsContent.innerHTML=`<h3>${name}</h3>`;
    units.forEach(u=>{
        detailsContent.innerHTML+=`
        <div class="unit-item"
        onclick="addToCart('${name}','${u.unitName}',${u.price})">
        ${u.unitName} - ${u.price} Ø¬Ù†ÙŠÙ‡
        </div>`;
    });
}

function closePopup(){ detailsPopup.style.display="none"; }

/* ================= CART ================= */
function addToCart(item,unit,price){
    const f=cart.find(x=>x.item===item&&x.unit===unit);
    f?f.qty++:cart.push({item,unit,price,qty:1});
    saveCart();
}

function increase(i){cart[i].qty++;saveCart();}
function decrease(i){cart[i].qty--; if(cart[i].qty<=0)cart.splice(i,1); saveCart();}
function removeItem(i){cart.splice(i,1);saveCart();}
function clearCart(){cart=[];saveCart();}

function saveCart(){
    localStorage.setItem("cart",JSON.stringify(cart));
    renderCart();
}

function renderCart(){
    cartItems.innerHTML="";
    let total=0;
    cart.forEach((c,i)=>{
        total+=c.price*c.qty;   
        cartItems.innerHTML+=`
        <div class="cart-row">
        ${c.item}<br>${c.unitName}
        <div>
        <button onclick="decrease(${i})">âˆ’</button>
        ${c.qty}
        <button onclick="increase(${i})">+</button>
        <button onclick="removeItem(${i})">âœ–</button>
        </div></div>`;
    });
    cartTotal.textContent="Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: "+total+" Ø¬Ù†ÙŠÙ‡";
}

/* ================= WHATSAPP ================= */
function sendOrder(){
    if(!cart.length)return alert("Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©");
    let msg="Ù…Ø·Ø¹Ù… ÙˆØ§Ø­Ø© Ø¯Ù…Ø´Ù‚\n";
    cart.forEach((c,i)=>{
        msg+=`${i+1}- ${c.item} (${c.unit}) Ã— ${c.qty}\n`;
    });
    msg+=cartTotal.textContent;
    window.open("https://wa.me/+201001741790?text="+encodeURIComponent(msg));
}

/* ================= SYNC ================= */
function syncFromApi(){
    if(!navigator.onLine)return alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„");
    localStorage.removeItem("menuData");
    loadCategories();
}

/* INIT */
loadCategories();
renderCart();
</script>

</body>
</html>

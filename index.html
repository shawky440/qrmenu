<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>منيو المطعم</title>

<style>
body { margin:0; font-family:Tahoma; background:#f5f5f5; }
header {
    background:#d62828; color:#fff; text-align:center;
    padding:20px; font-size:28px; cursor:pointer;
}
.categories-bar {
    display:flex; overflow-x:auto; gap:15px;
    padding:10px; background:#fff8f0;
}
.category {
    background:#d62828; color:#fff;
    padding:10px 20px; border-radius:10px;
    cursor:pointer; white-space:nowrap;
}
.items {
    display:flex; flex-wrap:wrap;
    gap:20px; justify-content:center;
    margin:20px;
}
.item {
    width:150px; background:#fff;
    border-radius:12px; overflow:hidden;
    box-shadow:0 4px 10px rgba(0,0,0,.1);
    cursor:pointer;
}
.item img { width:100%; height:140px; object-fit:cover; }
.info { padding:10px; text-align:center; font-weight:bold; }

.details-popup {
    display:none; position:fixed;
    inset:0; background:rgba(0,0,0,.6);
    justify-content:center; align-items:center;
}
.details-content {
    background:#fff; padding:20px;
    border-radius:12px; width:90%;
    max-width:400px; max-height:80%;
    overflow:auto;
}
.unit-item {
    margin:10px 0; padding:10px;
    border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,.2);
}
.unit-item img {
    width:100%; height:90px; object-fit:cover;
    border-radius:8px;
}
#okBtn {
    width:100%; background:#d62828;
    color:#fff; padding:12px;
    border:none; border-radius:10px;
    font-size:18px; margin-top:15px;
}
.footer {
    background:#222; color:#fff;
    text-align:center; padding:10px;
    position:fixed; bottom:0; width:100%;
}
</style>
</head>

<body>

<header onclick="manualRefresh()">مطعم واحة دمشق</header>

<div id="menu" class="categories-bar"></div>
<div id="itemsContainer" class="items"></div>

<div id="detailsPopup" class="details-popup">
    <div class="details-content">
        <div id="detailsContent"></div>
        <button id="okBtn" onclick="closePopup()">موافق</button>
    </div>
</div>

<footer class="footer">© 2025 MicrosysEgypt.com</footer>

<script>
/* ================= CONFIG ================= */
const API = "http://192.168.1.2:5000/api";
const STORE_KEY = "OFFLINE_MENU";

/* ================= INIT ================= */
document.addEventListener("DOMContentLoaded", async () => {
    const online = await loadOnline();
    if (!online) loadOffline();
});

/* ================= FETCH ================= */
function fetchJSON(url) {
    const c = new AbortController();
    setTimeout(() => c.abort(), 4000);
    return fetch(url,{signal:c.signal}).then(r=>{
        if(!r.ok) throw "API Error";
        return r.json();
    });
}

/* ================= ONLINE ================= */
async function loadOnline() {
    try {
        const categories = await fetchJSON(`${API}/Categories?formid=7`);
        const items = {};
        const units = {};

        for (const c of categories) {
            items[c.id] = await fetchJSON(`${API}/Items/ByCategory/${c.id}`);
            for (const i of items[c.id]) {
                units[i.id] = await fetchJSON(`${API}/Items/${i.id}/Units`);
            }
        }

        const data = { categories, items, units };
        localStorage.setItem(STORE_KEY, JSON.stringify(data));
        renderCategories(data);
        return true;
    } catch {
        return false;
    }
}

/* ================= OFFLINE ================= */
function loadOffline() {
    const raw = localStorage.getItem(STORE_KEY);
    if (!raw) {
        document.body.innerHTML = "<h2 style='text-align:center'>لا توجد بيانات</h2>";
        return;
    }
    renderCategories(JSON.parse(raw));
}

/* ================= RENDER ================= */
let CACHE;

function renderCategories(data) {
    CACHE = data;
    const menu = document.getElementById("menu");
    menu.innerHTML = "";
    data.categories.forEach(c => {
        const d = document.createElement("div");
        d.className = "category";
        d.textContent = c.nameA;
        d.onclick = () => renderItems(c.id);
        menu.appendChild(d);
    });
}

function renderItems(catId) {
    const box = document.getElementById("itemsContainer");
    box.innerHTML = "";
    (CACHE.items[catId]||[]).forEach(i => {
        const img = i.itemImg?.length>50 ? 
        `data:image/jpeg;base64,${i.itemImg}` : "noimage.png";

        const d = document.createElement("div");
        d.className = "item";
        d.innerHTML = `<img src="${img}"><div class="info">${i.nameA}</div>`;
        d.onclick = () => showUnits(i.id,i.nameA);
        box.appendChild(d);
    });
}

function showUnits(itemId,name) {
    let html = `<h3>${name}</h3>`;
    (CACHE.units[itemId]||[]).forEach(u=>{
        const img = u.image?.length>50 ?
        `<img src="data:image/jpeg;base64,${u.image}">` : "";
        html += `<div class="unit-item">
        ${img}<div>${u.unitName} - ${u.price} جنيه</div></div>`;
    });
    document.getElementById("detailsContent").innerHTML = html;
    document.getElementById("detailsPopup").style.display="flex";
}

/* ================= ACTIONS ================= */
function closePopup(){
    document.getElementById("detailsPopup").style.display="none";
}

function manualRefresh(){
    loadOnline().then(ok=>{
        if(!ok) alert("لا يوجد اتصال بالسيرفر");
    });
}
</script>

</body>
</html>

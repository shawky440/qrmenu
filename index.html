<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>منيو المطعم</title>
<style>
/* نفس التنسيقات السابقة */
body { margin:0; font-family:Tahoma; background:#f5f5f5; color:#222; }
header { background:#d62828; color:#fff; text-align:center; padding:20px; font-size:28px; cursor:pointer; }
.categories-bar { display:flex; overflow-x:auto; gap:15px; padding:10px; background:#fff8f0; }
.category { background:#d62828; color:white; padding:10px 20px; border-radius:10px; cursor:pointer; white-space:nowrap; }
.category:hover { background:#ff6f3c; }
.items { text-align: center; display:flex; flex-wrap: wrap; gap:20px; margin:20px; justify-content:center; }
.item {text-align:center; background:#fff; border-radius:12px; overflow:hidden; box-shadow:0 4px 10px rgba(0,0,0,0.1); width:150px; cursor:pointer; transition:0.25s;}
.item:hover { transform:scale(1.03); }
.item img { width:100%; height:140px; object-fit:cover; }
.info { padding:10px; font-weight:bold; text-align:center; }
.details-popup { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); justify-content:center; align-items:center; }
.details-content { background:#fff; padding:20px; border-radius:12px; max-width:400px; width:90%; max-height:80%; overflow-y:auto; }
.unit-item { margin:10px 0; padding:10px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,.2); }
.unit-item img { width:100%; height:90px; object-fit:cover; border-radius:8px; }
#okBtn { width:100%; background:#d62828; color:#fff; padding:12px; border:none; border-radius:10px; font-size:18px; margin-top:15px; }
.footer { background:#222; color:#fff; text-align:center; padding:10px; position:fixed; bottom:0; width:100%; }
</style>
</head>
<body>

<header onclick="exportData()" style="cursor:pointer">مطعم واحة دمشق</header>

<div class="categories-bar" id="menu"></div>
<div id="itemsContainer" class="items"></div>

<div class="details-popup" id="detailsPopup">
    <div class="details-content">
        <div id="detailsContent"></div>
        <button id="okBtn" onclick="closePopup()">موافق</button>
    </div>
</div>

<footer class="footer">© 2025 MicrosysEgypt.com</footer>

<script>
const API = "http://192.168.1.2:5000/api";
const JSON_FILE = "menu-data.json"; // JSON جاهز على GitHub أو محلي
const STORE_KEY = "OFFLINE_MENU";

let CACHE;

// بدء التحميل
document.addEventListener("DOMContentLoaded", async () => {
    const ok = await loadOnline();
    if(!ok) loadOffline();
});

async function fetchJSON(url) {
    const c = new AbortController();
    setTimeout(() => c.abort(), 5000);
    const res = await fetch(url, {signal: c.signal});
    if(!res.ok) throw "API Error";
    return res.json();
}

// ================= ONLINE =================
async function loadOnline() {
    try {
        const categories = await fetchJSON(`${API}/Categories?formid=7`);
        const items = {};
        const units = {};
        for(const c of categories){
            items[c.id] = await fetchJSON(`${API}/Items/ByCategory/${c.id}`);
            for(const i of items[c.id]){
                units[i.id] = await fetchJSON(`${API}/Items/${i.id}/Units`);
            }
        }
        CACHE = {categories, items, units};
        localStorage.setItem(STORE_KEY, JSON.stringify(CACHE)); // تخزين مؤقت في المتصفح
        renderCategories(CACHE);
        console.log("Data loaded from API ✅");
        return true;
    } catch(e){
        console.log("API unavailable, switching to JSON / Offline", e);
        return false;
    }
}

// ================= OFFLINE =================
async function loadOffline() {
    try {
        const raw = localStorage.getItem(STORE_KEY);
        if(raw){
            CACHE = JSON.parse(raw);
            renderCategories(CACHE);
            console.log("Data loaded from localStorage ✅");
        } else {
            // إذا لم يوجد localStorage اقرأ من JSON جاهز
            const data = await fetchJSON(JSON_FILE);
            CACHE = data;
            renderCategories(CACHE);
            console.log("Data loaded from JSON file ✅");
        }
    } catch(e){
        document.body.innerHTML = "<h2 style='text-align:center'>لا توجد بيانات</h2>";
        console.error(e);
    }
}

// ================= RENDER =================
function renderCategories(data) {
    const menu = document.getElementById("menu");
    menu.innerHTML = "";
    data.categories.forEach(c=>{
        const d = document.createElement("div");
        d.className="category";
        d.textContent=c.nameA;
        d.onclick = ()=> renderItems(c.id);
        menu.appendChild(d);
    });
}

function renderItems(catId){
    const box = document.getElementById("itemsContainer");
    box.innerHTML="";
    (CACHE.items[catId]||[]).forEach(i=>{
        const img = i.itemImg?.length>50 ? `data:image/jpeg;base64,${i.itemImg}` : "noimage.png";
        const d = document.createElement("div");
        d.className="item";
        d.innerHTML=`<img src="${img}"><div class="info">${i.nameA}</div>`;
        d.onclick = ()=>showUnits(i.id,i.nameA);
        box.appendChild(d);
    });
}

function showUnits(itemId,name){
    let html=`<h3>${name}</h3>`;
    (CACHE.units[itemId]||[]).forEach(u=>{
        const img = u.image?.length>50 ? `<img src="data:image/jpeg;base64,${u.image}">` : "";
        html+=`<div class="unit-item">${img}<div>${u.unitName} - ${u.price} جنيه</div></div>`;
    });
    document.getElementById("detailsContent").innerHTML=html;
    document.getElementById("detailsPopup").style.display="flex";
}

async function exportData() {
    try {
        const categories = await fetch(`${API}/Categories?formid=7`).then(r=>r.json());
        const items = {};
        const units = {};
        for(const c of categories){
            items[c.id] = await fetch(`${API}/Items/ByCategory/${c.id}`).then(r=>r.json());
            for(const i of items[c.id]){
                units[i.id] = await fetch(`${API}/Items/${i.id}/Units`).then(r=>r.json());
            }
        }
        const data = {categories, items, units};
        // حفظ مؤقت في localStorage
        localStorage.setItem("OFFLINE_MENU", JSON.stringify(data));
        
        // إنشاء ملف JSON قابل للتحميل
        const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "menu-data.json";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        alert("تم إنشاء ملف JSON بنجاح ✅");
    } catch(e){
        alert("لا يوجد اتصال بالسيرفر ❌");
        console.error(e);
    }
}
// ================= ACTIONS =================
function closePopup(){ document.getElementById("detailsPopup").style.display="none"; }
function manualRefresh(){ loadOnline().then(ok=>{ if(!ok) alert("لا يوجد اتصال بالسيرفر"); }); }
</script>
</body>
</html>
